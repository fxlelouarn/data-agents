# Status Tests NEW_EVENT - 1er DÃ©cembre 2025 18h

## âœ… ProblÃ¨me `createdIds undefined` RÃ©solu !

### Corrections ApportÃ©es

#### 1. âœ… Tests utilisent `result.createdIds.eventId`
- **Fichier** : `new-event.test.ts`
- **Recherche/remplacement** : `result.createdEventId` â†’ `parseInt(result.createdIds!.eventId!)`
- **Idem pour** : `createdEditionId`

#### 2. âœ… DatabaseManager.addTestConnection() ajoutÃ©e
- **Fichier** : `packages/agent-framework/src/database-manager.ts`
- **MÃ©thode** : Pour passer directement un client Prisma au lieu d'une config
- **Usage** : `service-setup.ts` passe `testMilesRepublicDb` directement

#### 3. âœ… Conversion `year` en String
- **Fichier** : `packages/database/src/services/proposal-domain.service.ts`
- **Lignes** : 1002, 1046
- **Changement** : `editionData.year.toString()`
- **Raison** : SchÃ©ma Miles Republic dÃ©finit `year: String` et non `Int`

### RÃ©sultats

ğŸ‰ **17 tests passent sur 33 (52%)** !

**Tests qui passent** :
- âœ… CrÃ©ation Event avec tous les champs
- âœ… CrÃ©ation Event avec champs minimum
- âœ… GÃ©nÃ©ration slug automatique
- âœ… toUpdate = true par dÃ©faut
- âœ… fullAddress gÃ©nÃ©rÃ©e automatiquement
- âœ… Gestion champs optionnels null
- âœ… CrÃ©ation unique slugs pour mÃªme nom
- âœ… CrÃ©ation Edition avec champs optionnels
- âœ… Gestion timezone diffÃ©rentes
- âœ… Statut calendrier par dÃ©faut
- âœ… Courses crÃ©Ã©es
- âœ… Distances correctes
- âœ… Ã‰lÃ©vations correctes
- âœ… StartDate courses correctes
- âœ… CatÃ©gories courses
- âœ… Distance 0 autorisÃ©e
- âœ… Ã‰lÃ©vation 0 autorisÃ©e

**Tests Ã  corriger** (11 Ã©checs) :
1. âš ï¸ Slug caractÃ¨res spÃ©ciaux (apostrophes retirÃ©es)
2. âš ï¸ Extraction code rÃ©gion (retourne "" au lieu de "BFC")
3. âš ï¸ Assertion `year` attendue en `Int` mais reÃ§oit `String`
4. âš ï¸ `currentEditionEventId` = null (doit Ãªtre = eventId)
5. âš ï¸ `dataSource` = "OTHER" (doit Ãªtre "FEDERATION" pour agent FFA)
6. âš ï¸ SchÃ©ma Edition n'a pas de relation `organizer`
7. âš ï¸ Champs optionnels retournent `undefined` au lieu de `null`
8. âš ï¸ SchÃ©ma Race n'a pas de champ `archivedAt`
9. âš ï¸ Timezone courses = null (doit hÃ©riter de l'Ã©dition)
10. âš ï¸ Race bike-only : `runDistance` = 0 (doit Ãªtre `null`)
11. âš ï¸ CatÃ©gories courses manquantes

### Prochaines Ã‰tapes

**Phase suivante** : Corriger les 11 tests Ã©chouants

1. Ajuster assertions pour `year: String`
2. ImplÃ©menter `currentEditionEventId = eventId` dans `applyNewEvent()`
3. Fixer `extractRegionCode()` pour BFC
4. ImplÃ©menter dÃ©duction `dataSource = FEDERATION` depuis agentId
5. Adapter helpers/assertions au vrai schÃ©ma Miles Republic
6. ImplÃ©menter hÃ©ritage timezone courses depuis Ã©dition
7. GÃ©rer distances nulles pour courses spÃ©cialisÃ©es (bike-only)
